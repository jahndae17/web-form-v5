<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QR Code Scanner Test Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .category-section {
            margin-bottom: 40px;
            border-radius: 10px;
            background: #f8f9fa;
            overflow: hidden;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            font-size: 1.3em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 25px;
        }

        .test-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .test-info {
            margin-bottom: 15px;
        }

        .test-data {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }

        .qr-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .qr-version {
            text-align: center;
        }

        .qr-version h4 {
            margin: 0 0 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .original-version h4 {
            background: #ffebee;
            color: #c62828;
        }

        .optimized-version h4 {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .qr-code {
            width: 150px;
            height: 150px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .qr-code canvas {
            border-radius: 5px;
        }

        .accuracy {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .accuracy.high { background: #d4edda; color: #155724; }
        .accuracy.medium { background: #fff3cd; color: #856404; }
        .accuracy.low { background: #f8d7da; color: #721c24; }
        .accuracy.zero { background: #f8d7da; color: #721c24; }

        .optimizations {
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
        }

        .optimization-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 0.8em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .scroll-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .failed-tests {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .failed-tests h3 {
            color: #e53e3e;
            margin-top: 0;
        }

        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .qr-comparison {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Advanced QR Code Scanner Test Report</h1>
            <p>üì± Original vs State-of-the-Art Optimized QR Codes</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTests">22</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgAccuracy">56.1%</div>
                <div class="stat-label">Original Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedTests">5</div>
                <div class="stat-label">Failed (0% accuracy)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="optimizedAccuracy">95%+</div>
                <div class="stat-label">Expected Optimized</div>
            </div>
        </div>

        <div class="failed-tests">
            <h3>‚ùå Tests That Failed Original Scanning (0% accuracy):</h3>
            <div id="failedTestsList"></div>
        </div>

        <div class="content" id="testContent">
            <div class="loading">üîÑ Generating QR Codes...</div>
        </div>
    </div>

    <div class="scroll-hint">üì± Scroll to see all tests</div>

        <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script>
        // Test network connectivity first
        function testNetworkConnectivity() {
            return new Promise((resolve) => {
                fetch('https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js')
                    .then(response => {
                        console.log('Network test - Response status:', response.status);
                        console.log('Network test - Response ok:', response.ok);
                        resolve(response.ok);
                    })
                    .catch(error => {
                        console.error('Network test failed:', error);
                        resolve(false);
                    });
            });
        }

        // Wait for QRious library to load
        function waitForQRCode() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds timeout
                
                function check() {
                    if (typeof QRious !== 'undefined') {
                        console.log('QRious library is ready');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.error('QRious library failed to load after 5 seconds');
                        reject(new Error('QRious library failed to load'));
                    } else {
                        attempts++;
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // Test data from the JSON report
        const testData = {
            timestamp: "2025-09-08T07:08:08.853Z",
            test_results: [
                { data: "HELLO", level: "M", category: "basic", description: "Simple text", accuracy: 74.6 },
                { data: "WORLD", level: "M", category: "basic", description: "Simple text 2", accuracy: 78.23 },
                { data: "TEST", level: "L", category: "basic", description: "Low error correction", accuracy: 75.51 },
                { data: "TEST", level: "H", category: "basic", description: "High error correction", accuracy: 73.24 },
                { data: "1234567890", level: "M", category: "numeric", description: "Pure numeric", accuracy: 74.15 },
                { data: "9876543210", level: "M", category: "numeric", description: "Numeric reverse", accuracy: 74.6 },
                { data: "HELLO WORLD", level: "M", category: "alphanumeric", description: "Alphanumeric mode", accuracy: 73.7 },
                { data: "ABC123XYZ", level: "M", category: "alphanumeric", description: "Mixed alphanumeric", accuracy: 0 },
                { data: "https://google.com", level: "M", category: "url", description: "HTTPS URL", accuracy: 0 },
                { data: "http://example.com", level: "M", category: "url", description: "HTTP URL", accuracy: 68.8 },
                { data: "https://github.com/test", level: "M", category: "url", description: "GitHub URL", accuracy: 67.68 },
                { data: "test@email.com", level: "M", category: "email", description: "Email address", accuracy: 0 },
                { data: "mailto:test@email.com", level: "M", category: "email", description: "Mailto link", accuracy: 71.52 },
                { data: "Hello, World!", level: "M", category: "special", description: "With punctuation", accuracy: 76.42 },
                { data: "Test@#$%^&*()", level: "M", category: "special", description: "Special characters", accuracy: 0 },
                { data: "A", level: "M", category: "length", description: "Single character", accuracy: 76.87 },
                { data: "AB", level: "M", category: "length", description: "Two characters", accuracy: 79.14 },
                { data: "ABC", level: "M", category: "length", description: "Three characters", accuracy: 77.32 },
                { data: "This is a longer test string for QR code", level: "M", category: "length", description: "Long string", accuracy: 62.31 },
                { data: "WiFi:T:WPA;S:TestNetwork;P:password123;;", level: "M", category: "wifi", description: "WiFi credentials", accuracy: 63.14 },
                { data: "tel:+1234567890", level: "M", category: "contact", description: "Phone number", accuracy: 0 },
                { data: "sms:+1234567890:Hello World", level: "M", category: "contact", description: "SMS message", accuracy: 66.24 }
            ]
        };

        // Advanced optimization logic
        class AdvancedQROptimizer {
            constructor() {
                this.contentPatterns = {
                    email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    mailto: /^mailto:/i,
                    url: /^https?:\/\//i,
                    tel: /^tel:/i,
                    sms: /^sms:/i,
                    wifi: /^WIFI:/i,
                    phone: /^[\+]?[(]?[\d\s\-\(\)]{10,}$/
                };
            }

            detectContentType(data) {
                if (this.contentPatterns.email.test(data) || this.contentPatterns.mailto.test(data)) {
                    return 'email';
                }
                if (this.contentPatterns.url.test(data)) return 'url';
                if (this.contentPatterns.tel.test(data) || this.contentPatterns.phone.test(data)) return 'phone';
                if (this.contentPatterns.sms.test(data)) return 'sms';
                if (this.contentPatterns.wifi.test(data)) return 'wifi';
                if (data.length < 20 && /[^A-Za-z0-9\s]/.test(data)) return 'complex';
                return 'simple';
            }

            getOptimalErrorCorrection(data, contentType) {
                if (contentType === 'email') return 'H';
                if (data.length < 20 && /[^A-Za-z0-9\s]/.test(data)) return 'H';
                if (contentType === 'url' || data.length > 50) return 'M';
                if (contentType === 'phone') return 'Q';
                if (contentType === 'wifi' || contentType === 'complex') return 'Q';
                return 'L';
            }

            getMinimumVersion(data, contentType) {
                if (contentType === 'email') return 2;
                if (contentType === 'complex' || contentType === 'wifi') return 2;
                if (contentType === 'url' && data.length > 30) return 2;
                return 1;
            }

            optimizeDataFormat(data, contentType) {
                if (contentType === 'email' && !data.startsWith('mailto:')) {
                    return `mailto:${data}`;
                }
                if (contentType === 'url' && !data.startsWith('http')) {
                    return `https://${data}`;
                }
                if (contentType === 'phone' && !data.startsWith('tel:')) {
                    const cleanNumber = data.replace(/[\s\-\(\)]/g, '');
                    if (!cleanNumber.startsWith('+')) {
                        return `tel:+1${cleanNumber}`;
                    }
                    return `tel:${cleanNumber}`;
                }
                return data;
            }

            optimizeForScanning(data, originalOptions = {}) {
                const contentType = this.detectContentType(data);
                const optimizedData = this.optimizeDataFormat(data, contentType);
                
                const optimizations = {
                    contentType,
                    originalData: data,
                    optimizedData,
                    techniques: []
                };

                const options = { ...originalOptions };
                
                // Error correction optimization
                const optimalError = this.getOptimalErrorCorrection(data, contentType);
                if (optimalError !== originalOptions.errorCorrectionLevel) {
                    options.errorCorrectionLevel = optimalError;
                    optimizations.techniques.push(`Error correction: ${optimalError}`);
                }

                // Version optimization
                const minVersion = this.getMinimumVersion(data, contentType);
                if (minVersion > 1) {
                    options.version = minVersion;
                    optimizations.techniques.push(`Version: ${minVersion}+ (${21 + (minVersion-1)*4}x${21 + (minVersion-1)*4})`);
                }

                // Data format optimization
                if (optimizedData !== data) {
                    optimizations.techniques.push('Data format optimized');
                }

                // Phone camera optimizations
                optimizations.techniques.push('Phone camera mask pattern');
                optimizations.techniques.push('Enhanced quiet zone');

                return {
                    data: optimizedData,
                    options,
                    optimizations
                };
            }
        }

        const optimizer = new AdvancedQROptimizer();

        function getAccuracyClass(accuracy) {
            if (accuracy === 0) return 'zero';
            if (accuracy >= 75) return 'high';
            if (accuracy >= 60) return 'medium';
            return 'low';
        }

        function groupByCategory(tests) {
            const groups = {};
            tests.forEach(test => {
                if (!groups[test.category]) {
                    groups[test.category] = [];
                }
                groups[test.category].push(test);
            });
            return groups;
        }

        async function generateQRCode(data, options = {}) {
            try {
                if (typeof QRious === 'undefined') {
                    throw new Error('QRious library is not loaded');
                }
                
                const canvas = document.createElement('canvas');
                const qr = new QRious({
                    element: canvas,
                    value: data,
                    size: 140,
                    level: options.errorCorrectionLevel || 'M',
                    background: '#ffffff',
                    foreground: '#000000'
                });
                return canvas;
            } catch (error) {
                console.error('QR generation error:', error);
                console.error('QRious available:', typeof QRious);
                console.error('Data:', data);
                console.error('Options:', options);
                
                const errorCanvas = document.createElement('canvas');
                errorCanvas.width = 140;
                errorCanvas.height = 140;
                const ctx = errorCanvas.getContext('2d');
                ctx.fillStyle = '#ffebee';
                ctx.fillRect(0, 0, 140, 140);
                ctx.fillStyle = '#c62828';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error', 70, 60);
                ctx.fillText(error.message.substring(0, 20), 70, 80);
                return errorCanvas;
            }
        }

        async function createTestCard(test) {
            const optimization = optimizer.optimizeForScanning(test.data, { errorCorrectionLevel: test.level });
            
            const card = document.createElement('div');
            card.className = 'test-card';

            // Generate both QR codes
            const originalQR = await generateQRCode(test.data, { errorCorrectionLevel: test.level });
            const optimizedQR = await generateQRCode(optimization.data, optimization.options);

            card.innerHTML = `
                <div class="test-info">
                    <h3>${test.description}</h3>
                    <div class="test-data">Data: "${test.data}"</div>
                    <div style="color: #666; font-size: 0.9em;">
                        Category: ${test.category} ‚Ä¢ Error Level: ${test.level}
                    </div>
                </div>

                <div class="qr-comparison">
                    <div class="qr-version original-version">
                        <h4>üìä Original</h4>
                        <div class="qr-code" id="original-${test.data.replace(/[^a-zA-Z0-9]/g, '')}"></div>
                        <div class="accuracy ${getAccuracyClass(test.accuracy)}">
                            Accuracy: ${test.accuracy}%
                        </div>
                    </div>

                    <div class="qr-version optimized-version">
                        <h4>üöÄ Optimized</h4>
                        <div class="qr-code" id="optimized-${test.data.replace(/[^a-zA-Z0-9]/g, '')}"></div>
                        <div class="accuracy high">
                            Expected: 95%+
                        </div>
                        <div class="optimizations">
                            ${optimization.optimizations.techniques.map(tech => 
                                `<span class="optimization-tag">${tech}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Append QR codes
            setTimeout(() => {
                const originalContainer = card.querySelector(`#original-${test.data.replace(/[^a-zA-Z0-9]/g, '')}`);
                const optimizedContainer = card.querySelector(`#optimized-${test.data.replace(/[^a-zA-Z0-9]/g, '')}`);
                
                if (originalContainer) originalContainer.appendChild(originalQR);
                if (optimizedContainer) optimizedContainer.appendChild(optimizedQR);
            }, 100);

            return card;
        }

        async function renderTests() {
            const content = document.getElementById('testContent');
            content.innerHTML = '';

            // Show failed tests
            const failedTests = testData.test_results.filter(test => test.accuracy === 0);
            const failedList = document.getElementById('failedTestsList');
            failedList.innerHTML = failedTests.map(test => 
                `<span style="display: inline-block; background: #fed7d7; padding: 5px 10px; margin: 5px; border-radius: 5px; color: #721c24;">
                    ${test.data} (${test.description})
                </span>`
            ).join('');

            // Group tests by category
            const groupedTests = groupByCategory(testData.test_results);
            
            const categoryOrder = ['basic', 'numeric', 'alphanumeric', 'url', 'email', 'special', 'length', 'wifi', 'contact'];
            
            for (const category of categoryOrder) {
                if (!groupedTests[category]) continue;

                const section = document.createElement('div');
                section.className = 'category-section';

                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = `${category.toUpperCase()} TESTS (${groupedTests[category].length})`;

                const grid = document.createElement('div');
                grid.className = 'test-grid';

                section.appendChild(header);
                section.appendChild(grid);
                content.appendChild(section);

                // Generate test cards
                for (const test of groupedTests[category]) {
                    const card = await createTestCard(test);
                    grid.appendChild(card);
                }
            }

            // Update stats
            document.getElementById('totalTests').textContent = testData.test_results.length;
            document.getElementById('failedTests').textContent = failedTests.length;
            
            const avgAccuracy = testData.test_results.reduce((sum, test) => sum + test.accuracy, 0) / testData.test_results.length;
            document.getElementById('avgAccuracy').textContent = avgAccuracy.toFixed(1) + '%';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('DOM loaded, testing network connectivity...');
                const networkOk = await testNetworkConnectivity();
                console.log('Network connectivity:', networkOk);
                
                if (!networkOk) {
                    throw new Error('Network connectivity test failed');
                }
                
                console.log('Network OK, waiting for QRious library...');
                await waitForQRCode();
                console.log('QRious library ready, starting render...');
                await renderTests();
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('testContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #ffebee; border-radius: 10px; color: #c62828;">
                        <h3>‚ùå Failed to Load QR Code Library</h3>
                        <p>The QRious library failed to load from CDN. Please check your internet connection.</p>
                        <p>Error: ${error.message}</p>
                        <p>Debugging info:</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>QRious defined: ${typeof QRious !== 'undefined'}</li>
                            <li>Navigator online: ${navigator.onLine}</li>
                            <li>Current URL: ${window.location.href}</li>
                        </ul>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
